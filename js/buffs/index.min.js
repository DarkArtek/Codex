var REFRESH=config.refresh,SHOW_CD=30,debug=!1,user=new User;function logData(line){switch(line[0]){case"21":case"22":logAction(line[2],line[4],line[5],line[6]);break;case"26":gainBuff(line[5],line[7],line[2],parseFloat(line[4]),line[3]);break;case"30":loseBuff(line[5],line[7],line[2],line[3]);break;case"31":parseJob(line[2],line[3]);break;case"33":"40000010"===line[3]&&reload()}}function logAction(sourceId,actionId,actionName,targetId){user.hasBuff(actionId)&&gainBuff(sourceId,targetId,actionId,user.getBuff(actionId).data.duration,actionName)}function gainBuff(sourceId,targetId,buffId,buffTime,buffName){if(user.hasBuff(buffId)){var buff=user.getBuff(buffId);if(buff.target&&user.inParty(sourceId)||buff.self&&targetId===user.id||buff.party&&user.inParty(sourceId)){if(debug&&console.log("BUFF     "+buffName+" - "+buffId),buff.data.noRefresh&&buff.active)return;buff.active=!0,buff.cd=!1,buff.startTime=(new Date).getTime(),buff.duration=buff.data.duration,unHide(buffId),buffActiveUI(buffId),setTimeUI(buffId,buff.data.duration,buff.data.duration),user.resetInterval(buffId),user.intervals[buffId]=setInterval((function(){if(user.hasBuff(buffId)){var b_=user.getBuff(buffId);if(b_.active){var timeLeft=b_.duration-((new Date).getTime()-b_.startTime)/1e3;setTimeUI(buffId,Math.max(0,timeLeft),b_.duration,!0),timeLeft<=0&&cdBuff(sourceId,buffId,buffName)}}}),REFRESH)}}}function loseBuff(sourceId,targetId,buffId,buffName){}function cdBuff(sourceId,buffId,buffName){debug&&console.log("LOSEBUFF   "+buffId+" "+buffName),user.resetInterval(buffId),hide(buffId);var buff=user.getBuff(buffId);buff.data.noCd||(buff.active=!1,buff.cd=!0,buff.duration=buff.data.cd,buffOnCdUI(buffId),user.intervals[buffId]=setInterval((function(){if(user.hasBuff(buffId)){var b_=user.getBuff(buffId);if(b_.cd){var timeLeft=b_.duration-((new Date).getTime()-b_.startTime)/1e3;setTimeUI(buffId,Math.max(0,timeLeft),b_.duration,!1),timeLeft<=SHOW_CD&&unHide(buffId),timeLeft<=0&&readyBuff(sourceId,buffId,buffName)}}}),REFRESH))}function readyBuff(sourceId,buffId,buffName){user.resetInterval(buffId),user.getBuff(buffId).cd=!1,buffReadyUI(buffId)}function parseJob(sourceId,jobString){var jobId;sourceId==user.id&&switchJob(parseInt(jobString.substr(jobString.length-2,2),16))}function switchJob(jobId){user.setJob(jobId)&&(user.initPBuffs(),setJobUI(user.job),setupBuffsUI())}function inParty(id){return id===me.id||id in me.party}function reload(){user.reset(),user.initPBuffs(),setupBuffsUI()}async function init(){let combat=(await callOverlayHandler({call:"getCombatants"})).combatants;combat.length>0?(user.init(combat[0].ID.toString(16).toUpperCase()),switchJob(combat[0].Job),setupBuffsUI()):setTimeout((function(){init()}),1e3)}addOverlayListener("LogLine",data=>{logData(data.line)}),addOverlayListener("ChangePrimaryPlayer",data=>{""!==user.id&&data.charID.toString(16).toUpperCase()!==user.id&&location.reload()}),addOverlayListener("ChangeZone",data=>{user.setZone(data.zoneID)||reload()}),addOverlayListener("PartyChanged",data=>{user.changeParty(data.party)}),document.addEventListener("onOverlayStateUpdate",e=>{let docClassList=document.documentElement.classList;e.detail.isLocked?docClassList.add("locked"):docClassList.remove("locked")}),startOverlayEvents(),init();